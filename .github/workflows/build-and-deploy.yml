name: Build Assets and Test

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  build:
    name: Build and Prepare for Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ./app/bedrock/web/app/themes/shaganplaatjies/package-lock.json

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, cURL, openssl, PDO, pdo_mysql
          tools: composer:v2

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: app/bedrock/vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # ==========================================
      # LINTING & TESTS (Before Build)
      # ==========================================

      - name: Run ESLint
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: npm run lint
        continue-on-error: true

      - name: Check code formatting with Prettier
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: npx prettier --check "resources/js/**/*.js" "resources/css/**/*.css"
        continue-on-error: true

      # ==========================================
      # ASSET COMPILATION (For Shared Hosting)
      # ==========================================

      - name: Install Node dependencies
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: npm install

      - name: Build production assets
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: npm run production
        env:
          NODE_ENV: production

      - name: Verify dist directory
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: |
          echo "Checking compiled assets..."
          ls -lah dist/
          ls -la dist/mix-manifest.json

      # ==========================================
      # COMPOSER SETUP (For Shared Hosting)
      # ==========================================

      - name: Install PHP dependencies (for shared hosting)
        working-directory: ./app/bedrock
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Verify vendor directory
        working-directory: ./app/bedrock
        run: |
          echo "Checking vendor directory..."
          [ -d "vendor" ] && echo "✓ vendor directory exists" || echo "✗ vendor directory missing"
          ls vendor/ | head -5

      # ==========================================
      # TESTING
      # ==========================================

      - name: Run JavaScript tests
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: npm run jest
        continue-on-error: true

      - name: Run PHP tests
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: |
          if [ -f "composer.json" ] && grep -q "\"test\"" composer.json; then
            composer test
          else
            echo "No PHP tests configured, skipping..."
          fi
        continue-on-error: true

      # ==========================================
      # BUILD SUMMARY
      # ==========================================

      - name: Build summary
        run: |
          echo "✓ Assets compiled successfully"
          echo "✓ Vendor dependencies installed"
          echo ""
          echo "Note: Commit the dist/ and vendor/ folders manually to deploy"

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer:v2

      - name: Install Composer dependencies
        working-directory: ./app/bedrock
        run: composer install

      - name: Check for vulnerable PHP dependencies
        working-directory: ./app/bedrock
        run: composer audit
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Check for vulnerable npm dependencies
        working-directory: ./app/bedrock/web/app/themes/shaganplaatjies
        run: npm audit
        continue-on-error: true

  deployment-ready:
    name: Deployment Ready Check
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify deployment files
        run: |
          echo "=== DEPLOYMENT READINESS CHECK ==="
          echo ""
          echo "Checking dist directory..."
          if [ -d "app/bedrock/web/app/themes/shaganplaatjies/dist" ]; then
            echo "✓ dist directory exists"
            echo "  Files: $(find app/bedrock/web/app/themes/shaganplaatjies/dist -type f | wc -l)"
          else
            echo "✗ dist directory NOT found - DEPLOYMENT WILL FAIL"
            exit 1
          fi

          echo ""
          echo "Checking mix-manifest.json..."
          if [ -f "app/bedrock/web/app/themes/shaganplaatjies/mix-manifest.json" ]; then
            echo "✓ mix-manifest.json exists"
          else
            echo "✗ mix-manifest.json NOT found - DEPLOYMENT WILL FAIL"
            exit 1
          fi

          echo ""
          echo "Checking vendor directory..."
          if [ -d "app/bedrock/vendor" ]; then
            echo "✓ vendor directory exists"
            echo "  Packages: $(find app/bedrock/vendor -maxdepth 1 -type d | wc -l)"
          else
            echo "✗ vendor directory NOT found - DEPLOYMENT WILL FAIL"
            exit 1
          fi

          echo ""
          echo "=== READY FOR DEPLOYMENT ==="
          echo "All required files are present for shared hosting deployment."

      - name: Create deployment summary
        run: |
          echo "# ✅ Deployment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following files are ready for SFTP deployment:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`app/bedrock/web/app/themes/shaganplaatjies/dist/\` - Compiled CSS/JS" >> $GITHUB_STEP_SUMMARY
          echo "- \`app/bedrock/web/app/themes/shaganplaatjies/mix-manifest.json\` - Asset manifest" >> $GITHUB_STEP_SUMMARY
          echo "- \`app/bedrock/vendor/\` - PHP dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- All source files in \`app/bedrock/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review code changes in this pull request" >> $GITHUB_STEP_SUMMARY
          echo "2. Merge to main branch" >> $GITHUB_STEP_SUMMARY
          echo "3. This workflow will automatically build and commit assets" >> $GITHUB_STEP_SUMMARY
          echo "4. Download/clone the repo and deploy via SFTP to shared hosting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [SHARED-HOSTING.md](docs/SHARED-HOSTING.md) for detailed deployment instructions." >> $GITHUB_STEP_SUMMARY
